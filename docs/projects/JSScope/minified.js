var globalFrame={frameName:"global"},currentFrame=globalFrame;function highlight(e,r){(null!=e&&$(".CodeMirror-linenumber").eq(e).css("background","green"),null!=r)&&("rgb(0, 128, 0)"===$(".CodeMirror-linenumber").eq(r).css("background-color")&&$(".CodeMirror-linenumber").eq(r).css("background","#272822"))}function highlighForCall(e){null!=e&&($(".CodeMirror-linenumber").eq(e).css("background","rgb(150, 255, 150)"),$(".CodeMirror-linenumber").eq(e).css("color","black"))}function unhighlighForCall(e){null!=e&&($(".CodeMirror-linenumber").eq(e).css("background","#272822"),$(".CodeMirror-linenumber").eq(e).css("color",""))}function timeoutPromise(e){return new Promise(r=>{setTimeout(function(){r("done")},e)})}function withoutWhiteSpace(e){return e.trim()}function checkParents(e){for(var r=currentFrame;void 0===r[e];){if("global"===r.frameName)return[void 0,r];r=currentFrame.parentFrame}return[r[e],r]}function whichType(e){for(var r of identifiers){if((0,r[0])(e))return r[1]}return"invalid"}function isVariableDec(e){return new RegExp("^var .* = .*;$").test(withoutWhiteSpace(e))}function isConsoleLog(e){return new RegExp("^console.log(.*);$").test(withoutWhiteSpace(e))}function isFunctionDef(e){return new RegExp("^function .*(.*){$").test(withoutWhiteSpace(e))}function isFunctionCall(e){return new RegExp("^.*(.*);$").test(withoutWhiteSpace(e))}function isVariableChange(e){return new RegExp("^.* = .*;$").test(withoutWhiteSpace(e))}function isReturn(e){return new RegExp("^return .*;$").test(withoutWhiteSpace(e))}function isClose(e){return new RegExp("^}$").test(withoutWhiteSpace(e))}var identifiers=[[isVariableDec,"varDec"],[isConsoleLog,"console"],[isFunctionDef,"functionDef"],[isVariableChange,"varChng"],[isReturn,"return"],[isClose,"close"],[isFunctionCall,"functionCall"]];function resVariableDec(e){var r=e.match(/(?<=var ).*(?= \=)/),n=e.match(/(?<=\= ).*(?=;)/);currentFrame[r]=n}function resVariableChange(e){var r=withoutWhiteSpace(e.match(/.* (?==.*;)/)[0]),n=e.match(/(?<=\= ).*(?=;)/);checkParents(r)[1][r]=n}function resConsoleLog(e){var r=e.match(/(?<=console\.log\().*(?=\);)/)[0];if(null===r.match(/(?<=\").*(?=\")/)){var n=checkParents(r[0])[0];$("#console").append($(`<p>${n}</p>`))}else $("#console").append($(`<p>${r}</p>`))}function resFunctionDef(e){for(var r=e.match(/(?<=function ).*(?=\(\))/)[0],n=1,t=prgrmCount+1;t<prgrmLen;){var i=editor.getLine(t);if(isFunctionDef(i)&&n++,isClose(i)&&n--,0===n)return currentFrame[r]={isFunction:!0,startLine:prgrmCount+1,endLine:t,parentFrame:currentFrame,parentVisFrame:currentVisFrame},t;t++}return"invalid"}async function resFunctionCall(e){var r=e.match(/.*(?=\(\))/)[0],n=checkParents(r)[0],t=currentFrame,i=prgrmCount,o={frameName:r+":"+functionCounter,parentFrame:n.parentFrame};functionCounter++;var a={parent:n.parentVisFrame,me:o,children:[],active:!0};n.parentVisFrame.children.push(a);var u=currentVisFrame;currentVisFrame=a,currentFrame=o,await runCode({start:n.startLine,stop:n.endLine}),highlight(null,n.endLine-1),currentVisFrame.active=!1,currentVisFrame=u,currentFrame=t,prgrmCount=i}function resReturn(e){}function resClose(e){}var prgrmCount,prgrmLen,framesVisTree,currentVisFrame,editor,resolvers={varDec:resVariableDec,varChng:resVariableChange,console:resConsoleLog,functionDef:resFunctionDef,functionCall:resFunctionCall,return:resReturn,close:resClose},prevCount=0,functionCounter=0;async function runCode(e){var r,n;for(prgrmLen=editor.lineCount(),"click"==e.type?(r=0,n=prgrmLen,currentVisFrame=framesVisTree={parent:null,me:globalFrame,children:[],active:!0},functionCounter=0):(r=e.start,n=e.stop),prgrmCount=r;prgrmCount<n;prgrmCount++){let e=withoutWhiteSpace(editor.getLine(prgrmCount));await timeoutPromise(800),highlight(prgrmCount,0===prgrmCount?null:prevCount);var t=whichType(e);if(prevCount=prgrmCount,"invalid"!==t){var i=resolvers[t];"functionDef"===t?prgrmCount=i(e):"functionCall"===t?(highlighForCall(prgrmCount),await i(e),unhighlighForCall(prgrmCount)):i(e)}visualize()}console.log("hi"),await timeoutPromise(800),highlight(null,editor.lineCount()-1)}function cleanUP(){}function visualize(){$("#display").empty(),visualizeTree(framesVisTree,$("#display"))}function visualizeTree(e,r){var n=$(`<div class = "frame ${e.active?"active":"inactive"}" id = ${e.me.frameName}> </div>`);for(prop in e.me)"parentFrame"==prop?n.append($(`<p>${prop}: ${e.me[prop].frameName}</p>`)):e.me[prop].isFunction||n.append($(`<p>${prop}: ${e.me[prop]}</p>`));for(child of(r.append(n),e.children))visualizeTree(child,n)}addEventListener("load",()=>{editor=CodeMirror(document.querySelector("#code-editor"),{lineNumbers:!0,firstLineNumber:0,tabSize:2,value:"var a = '10';\nfunction b(){\n  a = 5;  \n  c();\n  console.log(d);\n}\nfunction c(){\n  d = 6;\n  var a = 7;\n  e = 9;\n  function f(){\n    a = 2;\n  }\n  f();\n}\nb();",mode:{name:"javascript"},theme:"monokai"}),$("#run").on("click",runCode)});